# Hanachan V2 - Bug & Architectural Debt Report
Date: 2026-01-25
Status: Optimized & Validated

## 1. Resolved Bugs (Fixed)

### 1.1 Postgres 22P02 (Invalid Text Representation)
- **Problem**: INTERCENTED. Queries were passing non-UUID strings into UUID columns.
- **Improved Implementation**: 
    - Moved Zod `parse()` calls to the **Service Layer** (`learning/service.ts`, `analytics/service.ts`, etc.) to respect the Persistence/Domain boundary.
    - `db.ts` now receives trusted, typed inputs.
- **Reference**: `src/lib/validations.ts`

### 1.2 Ghost Loading Overlay (Root Cause of Test Failures)
- **Problem**: `loading.tsx` was blocking Playwright interactions due to a high z-index overlay.
- **Fix**: 
    - Modified `loading.tsx` to handle pointer-events correctly.
    - Added `data-testid="global-loading"` for test targeting.
    - Updated `basic.test.ts` to explicitly wait for `global-loading` to be hidden before proceeding.

### 1.3 Auth StorageState Desync
- **Problem**: Storage state was captured before session cookies were fully settled.
- **Fix**:
    - Added a `waitForFunction` in `auth.setup.ts` to verify the existence of the Supabase auth cookie (`sb-*-auth-token`) before saving state.
    - Combined with `networkidle` and UI stability checks.

---

## 2. Updated Architectual Rules
- **Rule 1**: `db.ts` files must NEVER contain Zod `parse()` logic. Use the Service layer for validation.
- **Rule 2**: All global overlays (loading, splash) must follow the `pointer-events-auto` + `data-testid` pattern for testability.
- **Rule 3**: `repository.ts` filenames are permanently forbidden.

---

## 3. Next Steps for Developer
1. Run local playwright tests (`npx playwright test`).
2. Verify that the "Neural Reconstitution" overlay unmounts instantly upon auth data resolution.
3. Check Browser logs (now piped to Playwright output) for "DEBUG" messages if hydration issues persist.
