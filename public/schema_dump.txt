-- ========================================================
-- ANTI-VIBE SCHEMA: HANACHAN
-- Source of Truth: SQL
-- ========================================================

-- TEARDOWN (RESET)
DROP VIEW IF EXISTS public.active_reviews CASCADE;
DROP TABLE IF EXISTS public.assessment_results CASCADE;
DROP TABLE IF EXISTS public.assessment_questions CASCADE;
DROP TABLE IF EXISTS public.learner_progress CASCADE;
DROP TABLE IF EXISTS public.review_logs CASCADE;
DROP TABLE IF EXISTS public.srs_items CASCADE;
DROP TABLE IF EXISTS public.content_grammar CASCADE;
DROP TABLE IF EXISTS public.content_vocabulary CASCADE;
DROP TABLE IF EXISTS public.content_kanji CASCADE;
DROP TABLE IF EXISTS public.content_radicals CASCADE;
DROP TABLE IF EXISTS public.profiles CASCADE;

DROP TYPE IF EXISTS public.user_role CASCADE;
DROP TYPE IF EXISTS public.user_tier CASCADE;

DROP FUNCTION IF EXISTS public.handle_new_user CASCADE;

-- ENUMS
CREATE TYPE user_role AS ENUM ('GUEST', 'MEMBER', 'PREMIUM', 'ADMIN');
CREATE TYPE user_tier AS ENUM ('GUEST', 'FREE', 'PREMIUM', 'PREM_PRO');
CREATE TYPE content_type AS ENUM ('radical', 'kanji', 'vocabulary', 'grammar');
CREATE TYPE srs_item_state AS ENUM ('lesson', 'review', 'burned', 'suspended');
CREATE TYPE level_status AS ENUM ('pending', 'claimed');
CREATE TYPE practice_source AS ENUM ('recent_mistakes', 'recent_sessions', 'custom_deck', 'manual');
CREATE TYPE deck_source AS ENUM ('manual', 'system', 'ai');

-- LEVELS
CREATE TABLE IF NOT EXISTS public.levels (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL,
  exp_required INTEGER NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- PROFILES: Extends Supabase auth.users
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE,
  full_name TEXT,
  avatar_url TEXT,
  role user_role DEFAULT 'MEMBER' NOT NULL,
  tier user_tier DEFAULT 'FREE' NOT NULL,
  current_level_id INTEGER DEFAULT 1 REFERENCES public.levels(id),
  exp INTEGER DEFAULT 0 NOT NULL,
  usage JSONB DEFAULT '{"ai_calls": {"count": 0, "lastResetMonth": ""}}'::jsonb,
  stripe_customer_id TEXT,
  subscription_status TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- LEVEL CONTENT MAPPING
CREATE TABLE IF NOT EXISTS public.level_content (
  level_id INTEGER NOT NULL REFERENCES public.levels(id) ON DELETE CASCADE,
  content_id UUID NOT NULL,
  content_type content_type NOT NULL,
  PRIMARY KEY (level_id, content_id)
);

-- CONTENT TABLES
CREATE TABLE IF NOT EXISTS public.content_radicals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  character TEXT,
  name TEXT UNIQUE NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  level INTEGER NOT NULL,
  meaning TEXT NOT NULL,
  mnemonic TEXT NOT NULL,
  url TEXT,
  mnemonic_image JSONB, -- { src: string, alt: string }
  kanji_slugs TEXT[],
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE TABLE IF NOT EXISTS public.content_kanji (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  character TEXT UNIQUE NOT NULL,
  level INTEGER NOT NULL,
  url TEXT,
  meanings JSONB NOT NULL, -- { primary: string[], alternatives: string[], mnemonic: string }
  readings JSONB NOT NULL, -- { onyomi: string[], kunyomi: string[], nanori: string[], mnemonic: string }
  radicals JSONB[], -- List of { character: string, name: string, url: string }
  visually_similar JSONB[],
  amalgamations JSONB[],
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE TABLE IF NOT EXISTS public.content_vocabulary (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  character TEXT UNIQUE NOT NULL,
  level INTEGER NOT NULL,
  url TEXT,
  meanings JSONB NOT NULL, -- { primary: string[], alternatives: string[], word_types: string[], explanation: string }
  readings JSONB NOT NULL, -- { primary: string, explanation: string, audio: Json[] }
  collocations JSONB[],
  context_sentences JSONB[], -- List of { ja: string, en: string }
  components JSONB[],
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE TABLE IF NOT EXISTS public.content_grammar (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,
  title TEXT NOT NULL,
  level INTEGER NOT NULL, -- Standardized to INTEGER
  url TEXT,
  meanings TEXT[],
  structure JSONB NOT NULL, -- { patterns: string[], variants: Json }
  details JSONB NOT NULL,
  about JSONB NOT NULL,
  examples JSONB[],
  related JSONB[],
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- DECKS
CREATE TABLE IF NOT EXISTS public.user_decks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  source deck_source DEFAULT 'manual' NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE TABLE IF NOT EXISTS public.deck_content (
  deck_id UUID NOT NULL REFERENCES public.user_decks(id) ON DELETE CASCADE,
  content_id UUID NOT NULL,
  content_type content_type NOT NULL,
  PRIMARY KEY (deck_id, content_id)
);

-- SRS SYSTEM
CREATE TABLE IF NOT EXISTS public.srs_items (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  content_id UUID NOT NULL, -- Standardized UUID
  content_type content_type NOT NULL,
  
  srs_stage INTEGER DEFAULT 0 NOT NULL,
  item_state srs_item_state DEFAULT 'lesson' NOT NULL,
  level_status level_status DEFAULT 'pending' NOT NULL,
  
  content_level_snapshot INTEGER, -- Prevent bugs if content levels change
  claimable_at_level INTEGER, -- Usually same as snapshot, allows flex
  
  learned_at TIMESTAMPTZ,
  claimed_at TIMESTAMPTZ,
  next_review TIMESTAMPTZ,
  available_at TIMESTAMPTZ,
  last_review TIMESTAMPTZ,
  incorrect_streak INTEGER DEFAULT 0 NOT NULL,
  
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,

  UNIQUE(user_id, content_id, content_type)
);

CREATE TABLE IF NOT EXISTS public.review_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  srs_item_id UUID REFERENCES public.srs_items(id) ON DELETE SET NULL,
  is_correct BOOLEAN NOT NULL,
  old_srs_stage INTEGER,
  new_srs_stage INTEGER NOT NULL,
  answer_result JSONB, -- tracks {meaning: bool, reading: bool}
  duration_ms INTEGER,
  answered_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE TABLE IF NOT EXISTS public.practice_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  content_id UUID NOT NULL,
  content_type content_type NOT NULL,
  source practice_source NOT NULL,
  is_correct BOOLEAN NOT NULL,
  duration_ms INTEGER,
  answered_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE TABLE IF NOT EXISTS public.learner_progress (
  user_id UUID PRIMARY KEY REFERENCES public.profiles(id) ON DELETE CASCADE,
  vocab_mastered INTEGER DEFAULT 0 NOT NULL,
  kanji_mastered INTEGER DEFAULT 0 NOT NULL,
  grammar_mastered INTEGER DEFAULT 0 NOT NULL,
  current_streak INTEGER DEFAULT 0 NOT NULL,
  last_activity TIMESTAMPTZ,
  level_scores JSONB,
  
  -- Pace & Performance Tracking
  performance_breakdown JSONB DEFAULT '{}'::jsonb, -- {at_or_below: {...}, ahead: {...}}
  ahead_items_active INTEGER DEFAULT 0 NOT NULL,
  ahead_reviews_last_7d INTEGER DEFAULT 0 NOT NULL,
  pace_feedback_state TEXT DEFAULT 'normal' NOT NULL, -- normal, fast_but_healthy, too_fast_risking_retention
  
  updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- FUNCTIONS & TRIGGERS
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name, avatar_url)
  VALUES (new.id, new.email, new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'avatar_url');
  
  INSERT INTO public.learner_progress (user_id)
  VALUES (new.id);
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;

CREATE OR REPLACE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- ASSESSMENT & EXAMS
CREATE TABLE IF NOT EXISTS public.assessment_questions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  question_text TEXT NOT NULL,
  options JSONB NOT NULL, -- List of { text: string, is_correct: boolean }
  explanation TEXT,
  category TEXT NOT NULL, -- 'radical', 'kanji', 'vocabulary', 'grammar'
  level TEXT NOT NULL, -- 'N5', 'N4', etc
  tags TEXT[],
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE TABLE IF NOT EXISTS public.assessment_results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  assessment_type TEXT NOT NULL, -- 'quiz', 'mock_test', 'exam'
  score INTEGER NOT NULL,
  total INTEGER NOT NULL,
  details JSONB, -- Selection of specific questions/answers
  created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

-- VIEW FOR ACTIVE REVIEWS (Helps logic)
CREATE OR REPLACE VIEW public.active_reviews WITH (security_invoker = true) AS
SELECT 
    s.*,
    CASE 
        WHEN s.content_type = 'radical' THEN (SELECT row_to_json(r) FROM public.content_radicals r WHERE r.id = s.content_id)
        WHEN s.content_type = 'kanji' THEN (SELECT row_to_json(k) FROM public.content_kanji k WHERE k.id = s.content_id)
        WHEN s.content_type = 'vocabulary' THEN (SELECT row_to_json(v) FROM public.content_vocabulary v WHERE v.id = s.content_id)
        WHEN s.content_type = 'grammar' THEN (SELECT row_to_json(g) FROM public.content_grammar g WHERE g.id = s.content_id)
    END as content
FROM public.srs_items s
WHERE s.item_state = 'review' AND (s.next_review <= NOW() OR s.next_review IS NULL);
-- ENABLE ROW LEVEL SECURITY (RLS) FOR ALL TABLES
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.levels ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.level_content ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.content_radicals ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.content_kanji ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.content_vocabulary ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.content_grammar ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_decks ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.deck_content ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.srs_items ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.review_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.practice_logs ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.learner_progress ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.assessment_questions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.assessment_results ENABLE ROW LEVEL SECURITY;
