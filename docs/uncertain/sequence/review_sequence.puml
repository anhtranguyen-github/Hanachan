@startuml Review Sequence
skinparam monochrome true
skinparam shadowing false
skinparam defaultFontName "Segoe UI"

actor "Người dùng" as User
participant "Giao diện Ôn tập" as UI
participant "ReviewSessionController" as Controller
participant "LearningService" as Service
participant "srsRepository" as SRSRepo
participant "questionRepository" as QRepo

User -> UI : Nhấn "Bắt đầu ôn tập"
activate UI
UI -> Service : fetchDueItems(userId)
activate Service
Service -> SRSRepo : Lấy danh sách đến hạn (FSRS)
SRSRepo --> Service : Items
Service --> UI : Items
deactivate Service

UI -> Controller : initSession(items)
activate Controller
Controller -> QRepo : fetchQuestionsBatch(unitFacetPairs)
QRepo --> Controller : Questions
Controller -> SRSRepo : createReviewSession(userId, total)
SRSRepo --> Controller : sessionId
Controller --> UI : Ready
deactivate Controller

loop Cho từng mục ôn tập (Hàng đợi Drill)
    User -> UI : Nhập đáp án & Gửi
    UI -> Controller : submitAnswer(rating)
    activate Controller
    
    alt Trả lời Sai (Drill Mode)
        Controller -> Controller : wrongCount++
        Controller -> SRSRepo : updateReviewSessionItem(..., 'incorrect', 'again')
        Controller -> Controller : Đẩy xuống cuối hàng chờ (Requeue)
        Controller --> UI : Hiển thị "Trùng lặp" / "Sai rùi"
    else Trả lời Đúng (Commit Mode)
        Controller -> Service : submitReview(..., rating, currentState, wrongCount)
        activate Service
        Service -> Service : Tính Intensity [log2(wrongCount+1)]
        Service -> Service : Cập nhật FSRS (One-shot)
        Service -> SRSRepo : updateUserState(stability, difficulty, reps)
        Service -> SRSRepo : Insert user_learning_logs
        Service --> Controller : Success
        deactivate Service
        
        Controller -> SRSRepo : updateReviewSessionItem(..., 'correct', rating)
        Controller -> SRSRepo : incrementSessionProgress()
        Controller -> Controller : Loại bỏ khỏi hàng chờ
        Controller --> UI : Hiển thị "Đúng rồi"
    end
    deactivate Controller
end

UI -> User : Thông báo hoàn thành
deactivate UI

@enduml
