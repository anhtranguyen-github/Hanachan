@startuml Chatbot Agentic Sequence
skinparam monochrome true
skinparam shadowing false
skinparam defaultFontName "Segoe UI"
skinparam sequenceMessageAlign center

actor "Người dùng" as User
participant "ChatbotPage" as UI
participant "HanachanChatService" as Agent
participant "curriculumRepository" as CurriculumRepo
participant "QuickViewModal" as Modal

User -> UI : Gửi tin nhắn (e.g. "Học tiếng Nhật")
activate UI
UI -> Agent : POST {message, history, userId}
activate Agent

Agent -> Agent : Inner Monologue:\n"Do I need facts from the curriculum?"

loop Cho từng thực thể tiềm năng
    Agent -> CurriculumRepo : search_curriculum(keyword)
    CurriculumRepo --> Agent : Dữ liệu tri thức (Kanji/Vocab)
end

Agent -> Agent : Tổng hợp phản hồi & Gắn kết thực thể (Entity Linking)

Agent --> UI : {reply, toolsUsed, referencedUnits}
deactivate Agent

UI -> UI : Hiển thị tin nhắn + Nút CTA (cho các Unit)
UI --> User : Giao diện đã cập nhật

User -> UI : Nhấn nút CTA (e.g. 語 • vocabulary)
UI -> CurriculumRepo : getUnit(type, slug)
activate CurriculumRepo
CurriculumRepo --> UI : Thông tin chi tiết Unit
deactivate CurriculumRepo

UI -> Modal : Open Modal(data)
activate Modal
Modal --> User : Hiển thị nghĩa, cách đọc, bộ thủ, ví dụ
User -> Modal : Đóng modal
deactivate Modal

deactivate UI

@enduml
