@startuml Chatbot Context-Aware Sequence
skinparam monochrome true
skinparam shadowing false
skinparam defaultFontName "Segoe UI"
skinparam sequenceMessageAlign center

actor "Người dùng" as User
participant "ChatbotPage" as UI
participant "AdvancedChatService" as Agent
participant "ChatRepository" as Repo
database "Supabase" as DB

User -> UI : Gửi tin nhắn (e.g. "Chốt dùng Tailwind")
activate UI
UI -> Agent : sendMessage(sessionId, userId, text)
activate Agent

Agent -> Repo : getSession(sessionId)
activate Repo
Repo -> DB : Fetch session & LAST 12 MESSAGES
DB --> Repo : Session Data (including summary)
Repo --> Agent : ChatSession object
deactivate Repo

Agent -> Agent : buildSystemContext(summary, intent)
note right: Includes current summary as "Working State"

Agent -> Agent : LLM Inference (GPT-4o)
note right: Decision made -> update summary

Agent -> Repo : updateSessionSummary(newSummary)
activate Repo
Repo -> DB : UPDATE chat_sessions.summary
deactivate Repo

Agent -> Repo : addMessage(reply)
activate Repo
Repo -> DB : INSERT chat_messages
deactivate Repo

Agent --> UI : {reply, actions}
deactivate Agent

UI --> User : Hiển thị phản hồi
deactivate UI

@enduml
