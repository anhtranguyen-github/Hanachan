@startuml Learn Sequence
skinparam monochrome true
skinparam shadowing false
skinparam defaultFontName "Segoe UI"

actor "Người dùng" as User
participant "Giao diện Học" as UI
participant "LearningController" as Controller
participant "LearningService" as Service
participant "lessonRepository" as LessonRepo
participant "srsRepository" as SRSRepo
participant "questionRepository" as QRepo

User -> UI : Bắt đầu bài học mới
activate UI

UI -> Service : fetchNewItems(userId, level)
activate Service
Service -> LessonRepo : Lấy dữ liệu Knowledge Units
LessonRepo --> Service : Items
Service --> UI : Items
deactivate Service

' PERSISTENCE
UI -> LessonRepo : createLessonBatch(userId, level)
activate LessonRepo
LessonRepo --> UI : batchId
deactivate LessonRepo

UI -> LessonRepo : createLessonItems(batchId, unitIds)
activate LessonRepo
LessonRepo --> UI : OK
deactivate LessonRepo

UI -> Controller : init(items, batchId)
activate Controller
Controller -> QRepo : fetchAllQuestionsForUnits(unitIds)
QRepo --> Controller : Questions
Controller --> UI : Ready
deactivate Controller

loop Xem bài giảng (Lesson Slides)
    User -> UI : Xem nội dung
    UI -> Controller : nextLessonItem()
    Controller -> LessonRepo : updateLessonItemStatus(batchId, unitId, 'viewed')
end

User -> UI : Bắt đầu kiểm tra (Quiz phase)
UI -> Controller : startQuiz()

loop Từng câu hỏi (Hàng đợi lặp lại cho đến khi đúng hết)
    User -> UI : Gửi câu trả lời
    UI -> Controller : submitQuizAnswer(rating)
    activate Controller
    
    opt Nếu hoàn thành tất cả khía cạnh của Unit (Quiz Passed)
        Controller -> LessonRepo : updateLessonItemStatus(batchId, unitId, 'quiz_passed')
        Controller -> Service : initializeSRS(userId, unitId, facets)
        Service -> SRSRepo : Tạo bản ghi UserLearningState (Stage: Learning, Stability: 4h)
    end
    
    Controller --> UI : Kết quả (Đúng/Sai)
    deactivate Controller
end

UI -> LessonRepo : completeLessonBatch(batchId)
UI -> User : Hiển thị tổng kết (Tỉ lệ chính xác, các mục đã học)
deactivate UI

@enduml
